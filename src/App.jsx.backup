import { useState, useEffect, useRef } from 'react';
import { 
  Shield, Zap, MapPin, Crown, AlertTriangle, Activity, Heart, 
  ChevronRight, DollarSign, Star, Clock, TrendingUp, Lock, Ticket,
  Menu, X, LogOut, User, Upload, CheckCircle, Loader, Image as ImageIcon,
  CreditCard, Wallet, Eye, Edit, Trash2, Plus, Filter, Package, MessageSquare
} from 'lucide-react';
import { supabase } from './supabase';

const PREFERENCE_LABELS = {
  A: { en: 'Nightclub', zh: 'Â§úÂ∫ó', ja: '„ÇØ„É©„Éñ' },
  B: { en: 'Bar', zh: 'ÈÖíÂêß', ja: '„Éê„Éº' },
  C: { en: 'Lounge', zh: 'Lounge', ja: '„É©„Ç¶„É≥„Ç∏' },
  D: { en: 'Pub', zh: 'ÈÖíÂêß', ja: '„Éë„Éñ' },
  E: { en: 'Karaoke', zh: 'Âç°ÊãâOK', ja: '„Ç´„É©„Ç™„Ç±' },
  F: { en: 'Rooftop', zh: 'È´òÁ©∫ÈÖíÂêß', ja: '„É´„Éº„Éï„Éà„ÉÉ„Éó' },
  G: { en: 'Club', zh: 'ÊúÉÂì°Âà∂ÈÖíÂêß', ja: '‰ºöÂì°Âà∂„ÇØ„É©„Éñ' }
};

const DECORATION_LEVELS = [
  { value: 'ËÄÅËàä', label: { en: 'Aged', zh: 'ËÄÅËàä', ja: 'Âè§„ÅÑ' } },
  { value: 'ÊôÆÈÄö', label: { en: 'Standard', zh: 'ÊôÆÈÄö', ja: 'ÊôÆÈÄö' } },
  { value: '‰∏≠‰∏ä', label: { en: 'Good', zh: '‰∏≠‰∏ä', ja: 'ËâØ„ÅÑ' } },
  { value: 'Â•¢ËèØ', label: { en: 'Luxury', zh: 'Â•¢ËèØ', ja: 'Ë±™ËèØ' } }
];

const FRIENDLINESS_LEVELS = [
  { value: '‰Ωé', label: { en: 'Low', zh: '‰Ωé', ja: '‰Ωé' } },
  { value: '‰∏≠', label: { en: 'Medium', zh: '‰∏≠', ja: '‰∏≠' } },
  { value: 'È´ò', label: { en: 'High', zh: 'È´ò', ja: 'È´ò' } }
];

const translations = {
  en: {
    nav: { dashboard: 'Dashboard', membership: 'Membership', gacha: 'Gacha', support: 'Support', login: 'Login', logout: 'Logout', credits: 'Credits', admin: 'Admin' },
    hero: { trustActive: 'Trust Protocol Active', title: "Navigate Bangkok's Neon Nights with Absolute Certainty", subtitle: 'The premier intelligence platform for premium travelers.', cta: 'Start Intelligence Trial', cta2: 'View Risk Map', verified: 'Verified Members', reports: 'Field Reports', satisfaction: 'Satisfaction Rate' },
    auth: { login: 'Login', signup: 'Sign Up', email: 'Email', password: 'Password', confirmPassword: 'Confirm Password', logout: 'Logout', noAccount: "Don't have an account?", hasAccount: 'Already have an account?', welcome: 'Welcome back!', selectPreferences: 'Select your preferences (multiple)' },
    dashboard: { title: 'Intelligence Dashboard', priceIndex: 'Bangkok Venue Price Index', updated: 'Updated: Live', trustProtocol: 'Trust Protocol Status', venueVerify: 'Venue Verification', priceSync: 'Price Index Sync', fieldAgent: 'Field Agent Network', emergency: '72-Hour Health Concierge', emergencyDesc: 'Urgent medical assistance, hospital navigation, and emergency translation services.', activate: 'Activate Emergency Protocol', viewAll: 'View All Venues', yourCredits: 'Your Credits', decoration: 'Decoration', friendliness: 'Friendliness', packages: 'Packages' },
    gacha: { title: 'The Siam Casino', subtitle: 'Upload payment proof ‚Üí Get credits ‚Üí Spin for rewards', spin: 'SPIN NOW', spinning: 'Spinning...', rewardPool: 'Reward Pool', uploadProof: 'Upload Payment Proof', uploadSuccess: 'Upload successful! Waiting for approval.', selectVenue: 'Select Venue', enterAmount: 'Amount (THB)', paymentType: 'Payment Type', receipt: 'Receipt', transfer: 'Transfer', card: 'Credit Card', pendingApproval: 'Pending approval', approved: 'Approved', rejected: 'Rejected', mySubmissions: 'My Submissions', noSubmissions: 'No submissions yet', uploadImage: 'Upload Image', selected: 'Selected' },
    membership: { title: 'Membership Tiers', subtitle: 'Choose your intelligence level', popular: 'MOST POPULAR', getStarted: 'Get Started', current: 'Current Plan' },
    emergency: { title: 'Emergency Request', success: 'Request submitted! We will contact you soon.' },
    venues: { title: 'All Venues', filter: 'Filter by category', all: 'All', price: 'Price', rating: 'Rating', risk: 'Risk' },
    admin: { title: 'Admin Panel', dashboard: 'Dashboard', venues: 'Manage Venues', users: 'Users', receipts: 'Receipts', approvals: 'Approvals', editVenue: 'Edit Venue', addVenue: 'Add Venue', save: 'Save', cancel: 'Cancel', approve: 'Approve', reject: 'Reject', totalUsers: 'Total Users', totalVenues: 'Total Venues', pendingReceipts: 'Pending Receipts', approvedReceipts: 'Approved', packages: 'Packages', addPackage: 'Add Package', packageName: 'Package Name', duration: 'Duration (min)', price: 'Price (THB)', description: 'Description', notes: 'Admin Notes', noPackages: 'No packages yet', noNotes: 'No notes yet' },
    footer: { privacy: 'Privacy', terms: 'Terms', contact: 'Contact', rights: 'All rights reserved.' }
  },
  zh: {
    nav: { dashboard: 'ÂÑÄË°®Êùø', membership: 'ÊúÉÂì°ÊñπÊ°à', gacha: 'ËΩâËõã', support: 'ÊîØÊè¥', login: 'ÁôªÂÖ•', logout: 'ÁôªÂá∫', credits: 'Á©çÂàÜ', admin: 'ÁÆ°ÁêÜ' },
    hero: { trustActive: '‰ø°‰ªªÂçîË≠∞Â∑≤ÂïüÂãï', title: 'ÁµïÂ∞çÁ¢∫ÂÆöÂú∞Êé¢Á¥¢ÊõºË∞∑ÈúìËôπ‰πãÂ§ú', subtitle: 'ÁÇ∫È´òÁ´ØÊóÖÈÅäËÄÖÊâìÈÄ†ÁöÑÈ¶ñÈÅ∏ÊÉÖÂ†±Âπ≥Âè∞„ÄÇ', cta: 'ÈñãÂßãÊÉÖÂ†±Ë©¶Áî®', cta2: 'Êü•ÁúãÈ¢®Èö™Âú∞Âúñ', verified: 'Â∑≤È©óË≠âÊúÉÂì°', reports: 'ÂØ¶Âú∞Â†±Âëä', satisfaction: 'ÊªøÊÑèÂ∫¶' },
    auth: { login: 'ÁôªÂÖ•', signup: 'Ë®ªÂÜä', email: 'ÈõªÂ≠êÈÉµ‰ª∂', password: 'ÂØÜÁ¢º', confirmPassword: 'Á¢∫Ë™çÂØÜÁ¢º', logout: 'ÁôªÂá∫', noAccount: 'ÈÇÑÊ≤íÊúâÂ∏≥ËôüÔºü', hasAccount: 'Â∑≤Á∂ìÊúâÂ∏≥ËôüÔºü', welcome: 'Ê≠°ËøéÂõû‰æÜÔºÅ', selectPreferences: 'ÈÅ∏Êìá‰Ω†ÁöÑÂñúÂ•ΩÔºàÂèØË§áÈÅ∏Ôºâ' },
    dashboard: { title: 'ÊÉÖÂ†±ÂÑÄË°®Êùø', priceIndex: 'ÊõºË∞∑Â∫óÂÆ∂ÂÉπÊ†ºÊéíÂ∫è', updated: 'Êõ¥Êñ∞ÔºöÂç≥ÊôÇ', trustProtocol: '‰ø°‰ªªÂçîË≠∞ÁãÄÊÖã', venueVerify: 'Â†¥Âú∞È©óË≠â', priceSync: 'ÂÉπÊ†ºÊåáÊï∏ÂêåÊ≠•', fieldAgent: 'ÁâπÊ¥æÂì°Á∂≤Áµ°', emergency: '72Â∞èÊôÇÂÅ•Â∫∑ÁÆ°ÂÆ∂', emergencyDesc: 'Á∑äÊÄ•ÈÜ´ÁôÇÂçîÂä©„ÄÅÈÜ´Èô¢Â∞éËà™„ÄÅÁ∑äÊÄ•ÁøªË≠ØÊúçÂãô„ÄÇ', activate: 'ÂïüÂãïÁ∑äÊÄ•ÂçîË≠∞', viewAll: 'Êü•ÁúãÂÖ®ÈÉ®Â†¥Âú∞', yourCredits: '‰Ω†ÁöÑÁ©çÂàÜ', decoration: 'Ë£ùÊΩ¢', friendliness: 'Ë¶™ÂíåÂäõ', packages: 'Â•óÈ§ê' },
    gacha: { title: 'ÊöπÁæÖË≥≠Â†¥', subtitle: '‰∏äÂÇ≥‰ªòÊ¨æË≠âÊòé ‚Üí Áç≤ÂæóÁ©çÂàÜ ‚Üí ËΩâËõãÊäΩÁçé', spin: 'Á´ãÂç≥ËΩâËõã', spinning: 'ËΩâËõã‰∏≠...', rewardPool: 'ÁçéÂãµÊ±†', uploadProof: '‰∏äÂÇ≥‰ªòÊ¨æË≠âÊòé', uploadSuccess: '‰∏äÂÇ≥ÊàêÂäüÔºÅÁ≠âÂæÖÂØ©Ê†∏‰∏≠„ÄÇ', selectVenue: 'ÈÅ∏ÊìáÂ†¥Âú∞', enterAmount: 'ÈáëÈ°ç (THB)', paymentType: '‰ªòÊ¨æÈ°ûÂûã', receipt: 'Êî∂Êìö', transfer: 'ËΩâÂ∏≥', card: 'Âà∑Âç°', pendingApproval: 'Á≠âÂæÖÂØ©Ê†∏', approved: 'Â∑≤ÈÄöÈÅé', rejected: 'Â∑≤ÊãíÁµï', mySubmissions: 'ÊàëÁöÑÊèê‰∫§', noSubmissions: 'Â∞öÊú™Êèê‰∫§', uploadImage: '‰∏äÂÇ≥ÂúñÁâá', selected: 'Â∑≤ÈÅ∏Êìá' },
    membership: { title: 'ÊúÉÂì°ÊñπÊ°à', subtitle: 'ÈÅ∏Êìá‰Ω†ÁöÑÊÉÖÂ†±Á¥öÂà•', popular: 'ÁÜ±ÈñÄ', getStarted: 'Á´ãÂç≥ÈñãÂßã', current: 'ÁõÆÂâçÊñπÊ°à' },
    emergency: { title: 'Á∑äÊÄ•Ë´ãÊ±Ç', success: 'Ë´ãÊ±ÇÂ∑≤Êèê‰∫§ÔºÅÊàëÂÄëÊúÉÂÑòÂø´ËÅØÁπ´‰Ω†„ÄÇ' },
    venues: { title: 'ÂÖ®ÈÉ®Â†¥Âú∞', filter: 'ÊåâÈ°ûÂûãÁØ©ÈÅ∏', all: 'ÂÖ®ÈÉ®', price: 'ÂÉπÊ†º', rating: 'Ë©ïÂàÜ', risk: 'È¢®Èö™' },
    admin: { title: 'ÁÆ°ÁêÜÂæåÂè∞', dashboard: 'ÂÑÄË°®Êùø', venues: 'ÁÆ°ÁêÜÂ∫óÂÆ∂', users: 'Áî®Êà∂', receipts: 'Êî∂Êìö', approvals: 'ÂØ©Ê†∏', editVenue: 'Á∑®ËºØÂ∫óÂÆ∂', addVenue: 'Êñ∞Â¢ûÂ∫óÂÆ∂', save: 'ÂÑ≤Â≠ò', cancel: 'ÂèñÊ∂à', approve: 'ÈÄöÈÅé', reject: 'ÊãíÁµï', totalUsers: 'Á∏ΩÁî®Êà∂', totalVenues: 'Á∏ΩÂ∫óÂÆ∂', pendingReceipts: 'ÂæÖÂØ©Ê†∏', approvedReceipts: 'Â∑≤ÈÄöÈÅé', packages: 'Â•óÈ§ê', addPackage: 'Êñ∞Â¢ûÂ•óÈ§ê', packageName: 'Â•óÈ§êÂêçÁ®±', duration: 'ÊôÇÈñì (ÂàÜÈêò)', price: 'ÂÉπÊ†º (THB)', description: 'Ë™™Êòé', notes: 'ÁÆ°ÁêÜÂì°Á≠ÜË®ò', noPackages: 'Â∞öÁÑ°Â•óÈ§ê', noNotes: 'Â∞öÁÑ°Á≠ÜË®ò' },
    footer: { privacy: 'Èö±ÁßÅ', terms: 'Ê¢ùÊ¨æ', contact: 'ËÅØÁµ°', rights: 'ÁâàÊ¨äÊâÄÊúâ„ÄÇ' }
  },
  ja: {
    nav: { dashboard: '„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ', membership: '„É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó', gacha: '„Ç¨„ÉÅ„É£', support: '„Çµ„Éù„Éº„Éà', login: '„É≠„Ç∞„Ç§„É≥', logout: '„É≠„Ç∞„Ç¢„Ç¶„Éà', credits: '„ÇØ„É¨„Ç∏„ÉÉ„Éà', admin: 'ÁÆ°ÁêÜ' },
    hero: { trustActive: '„Éà„É©„Çπ„Éà„Éó„É≠„Éà„Ç≥„É´Á®ºÂÉç‰∏≠', title: 'Áµ∂ÂØæ„ÅÆÁ¢∫‰ø°„Åß„Éê„É≥„Ç≥„ÇØ„ÅÆ„Éç„Ç™„É≥‰πãÂ§ú„Çí„Éä„Éì„Ç≤„Éº„Éà', subtitle: '„Éó„É¨„Éü„Ç¢„É†ÊóÖË°åËÄÖ„ÅÆ„Åü„ÇÅ„ÅÆÊúÄÈ´ò„ÅÆÊÉÖÂ†±„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„ÄÇ', cta: '„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„ÇπË©¶Áî®ÈñãÂßã', cta2: '„É™„Çπ„ÇØ„Éû„ÉÉ„Éó„ÇíË¶ã„Çã', verified: 'Ê§úË®ºÊ∏à„Åø„É°„É≥„Éê„Éº', reports: '„Éï„Ç£„Éº„É´„Éâ„É¨„Éù„Éº„Éà', satisfaction: 'Ê∫ÄË∂≥Â∫¶' },
    auth: { login: '„É≠„Ç∞„Ç§„É≥', signup: 'Êñ∞Ë¶èÁôªÈå≤', email: '„É°„Éº„É´', password: '„Éë„Çπ„ÉØ„Éº„Éâ', confirmPassword: '„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç', logout: '„É≠„Ç∞„Ç¢„Ç¶„Éà', noAccount: '„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Å™„ÅÑÔºü', hasAccount: 'Êó¢„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°Ôºü', welcome: '„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑÔºÅ', selectPreferences: 'Â•Ω„Åø„ÇíÈÅ∏ÊäûÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ' },
    dashboard: { title: '„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„Çπ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ', priceIndex: '„Éê„É≥„Ç≥„ÇØ‰ºöÂ†¥‰æ°Ê†º„É©„É≥„Ç≠„É≥„Ç∞', updated: 'Êõ¥Êñ∞Ôºö„É™„Ç¢„É´„Çø„Ç§„É†', trustProtocol: '„Éà„É©„Çπ„Éà„Éó„É≠„Éà„Ç≥„É´Áä∂ÊÖã', venueVerify: '‰ºöÂ†¥Ê§úË®º', priceSync: '‰æ°Ê†ºÊåáÊï∞ÂêåÊúü', fieldAgent: '„Éï„Ç£„Éº„É´„Éâ„Ç®„Éº„Ç∏„Çß„É≥„Éà„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ', emergency: '72ÊôÇÈñì„Éò„É´„Çπ„Ç≥„É≥„Ç∑„Çß„É´„Ç∏„É•', emergencyDesc: 'Á∑äÊÄ•ÂåªÁôÇÊîØÊè¥„ÄÅÁóÖÈô¢„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÄÅÁ∑äÊÄ•ÁøªË®≥„Çµ„Éº„Éì„Çπ„ÄÇ', activate: 'Á∑äÊÄ•„Éó„É≠„Éà„Ç≥„É´Ëµ∑Âãï', viewAll: 'ÂÖ®‰ºöÂ†¥„ÇíË¶ã„Çã', yourCredits: '„ÅÇ„Å™„Åü„ÅÆ„ÇØ„É¨„Ç∏„ÉÉ„Éà', decoration: 'ÂÜÖË£Ö', friendliness: 'Èõ∞Âõ≤Ê∞ó„Å•', packages: '„Éë„ÉÉ„Ç±„Éº„Ç∏' },
    gacha: { title: '„Ç∑„É£„É†„Ç´„Ç∏„Éé', subtitle: 'ÊîØÊâï„ÅÑË®ºÊòé„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ ‚Üí „ÇØ„É¨„Ç∏„ÉÉ„ÉàGET ‚Üí „Ç¨„ÉÅ„É£„ÇíÂõû„Åô', spin: 'Âõû„Åô', spinning: 'ÂõûËª¢‰∏≠...', rewardPool: 'Â†±ÈÖ¨„Éó„Éº„É´', uploadProof: 'ÊîØÊâï„ÅÑË®ºÊòé„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ', uploadSuccess: '„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊàêÂäüÔºÅÊâøË™çÂæÖ„Å°„ÄÇ', selectVenue: '‰ºöÂ†¥„ÇíÈÅ∏Êäû', enterAmount: 'ÈáëÈ°ç (THB)', paymentType: 'ÊîØÊâï„ÅÑÊñπÊ≥ï', receipt: '„É¨„Ç∑„Éº„Éà', transfer: 'ÊåØËæº', card: '„Ç´„Éº„Éâ', pendingApproval: 'ÊâøË™çÂæÖ„Å°', approved: 'ÊâøË™çÊ∏à„Åø', rejected: 'Âê¶Ê±∫', mySubmissions: '„Éû„Ç§ ÊèêÂá∫', noSubmissions: '„Åæ„Å†ÊèêÂá∫„Å™„Åó', uploadImage: 'ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ', selected: 'ÈÅ∏ÊäûÊ∏à„Åø' },
    membership: { title: '„É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó„ÉÜ„Ç£„Ç¢', subtitle: '„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„Çπ„É¨„Éô„É´„ÇíÈÅ∏Êäû', popular: '‰∫∫Ê∞ó', getStarted: 'Âßã„ÇÅ„Çã', current: 'ÁèæÂú®„ÅÆ„Éó„É©„É≥' },
    emergency: { title: 'Á∑äÊÄ•„É™„ÇØ„Ç®„Çπ„Éà', success: '„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°ÂÆå‰∫ÜÔºÅ„Åæ„ÇÇ„Å™„Åè„ÅîÈÄ£Áµ°„Åó„Åæ„Åô„ÄÇ' },
    venues: { title: 'ÂÖ®‰ºöÂ†¥', filter: '„Ç´„ÉÜ„Ç¥„É™„Åß„Éï„Ç£„É´„Çø„Éº', all: '„Åô„Åπ„Å¶', price: '‰æ°Ê†º', rating: 'Ë©ï‰æ°', risk: '„É™„Çπ„ÇØ' },
    admin: { title: 'ÁÆ°ÁêÜ„Éë„Éç„É´', dashboard: '„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ', venues: '‰ºöÂ†¥ÁÆ°ÁêÜ', users: '„É¶„Éº„Ç∂„Éº', receipts: '„É¨„Ç∑„Éº„Éà', approvals: 'ÊâøË™ç', editVenue: '‰ºöÂ†¥„ÇíÁ∑®ÈõÜ', addVenue: '‰ºöÂ†¥„ÇíËøΩÂä†', save: '‰øùÂ≠ò', cancel: '„Ç≠„É£„É≥„Çª„É´', approve: 'ÊâøË™ç', reject: 'Âê¶Ê±∫', totalUsers: 'Á∑è„É¶„Éº„Ç∂„Éº', totalVenues: 'Á∑è‰ºöÂ†¥', pendingReceipts: 'ÊâøË™çÂæÖ„Å°', approvedReceipts: 'ÊâøË™çÊ∏à„Åø', packages: '„Éë„ÉÉ„Ç±„Éº„Ç∏', addPackage: '„Éë„ÉÉ„Ç±„Éº„Ç∏„ÇíËøΩÂä†', packageName: '„Éë„ÉÉ„Ç±„Éº„Ç∏Âêç', duration: 'ÊôÇÈñì (ÂàÜ)', price: '‰æ°Ê†º (THB)', description: 'Ë™¨Êòé', notes: 'ÁÆ°ÁêÜËÄÖ„É°„É¢', noPackages: '„Éë„ÉÉ„Ç±„Éº„Ç∏„Å™„Åó', noNotes: '„É°„É¢„Å™„Åó' },
    footer: { privacy: '„Éó„É©„Ç§„Éê„Ç∑„Éº', terms: 'Âà©Áî®Ë¶èÁ¥Ñ', contact: 'ÈÄ£Áµ°ÂÖà', rights: 'ÂÖ®Ëëó‰ΩúÊ®©ÊâÄÊúâ„ÄÇ' }
  }
};

const tiers = [
  { name: { en: 'Survival Guide', zh: 'ÁîüÂ≠òÊåáÂçó', ja: '„Çµ„Éê„Ç§„Éê„É´„Ç¨„Ç§„Éâ' }, price: '$199', period: { en: 'one-time', zh: '‰∏ÄÊ¨°ÊÄß', ja: '‰∏ÄÊã¨' }, icon: MapPin, color: 'from-amber-600 to-amber-800', popular: false, tier: 'survival' },
  { name: { en: 'BoomBNav Radar', zh: 'BoomBNav Èõ∑ÈÅî', ja: 'BoomBNav „É¨„Éº„ÉÄ„Éº' }, price: '$599', period: { en: '/week', zh: '/ÈÄ±', ja: '/ÈÄ±' }, icon: Zap, color: 'from-purple-600 to-purple-900', popular: true, tier: 'radar' },
  { name: { en: 'The Black Card', zh: 'ÈªëÂç°', ja: '„Éñ„É©„ÉÉ„ÇØ„Ç´„Éº„Éâ' }, price: '$1,000', period: { en: '/month', zh: '/Êúà', ja: '/Êúà' }, icon: Crown, color: 'from-yellow-500 to-yellow-700', popular: false, tier: 'black' }
];

const gachaRewards = [
  { prize: { en: 'Free Drink Coupon', zh: 'ÂÖçË≤ªÈ£≤ÊñôÂà∏', ja: 'ÁÑ°Êñô„Éâ„É™„É≥„ÇØÂà∏' }, chance: '35%' },
  { prize: { en: 'VIP Upgrade', zh: 'VIPÂçáÁ¥ö', ja: 'VIP„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ' }, chance: '15%' },
  { prize: { en: '500 THB Credit', zh: '500Ê≥∞ÈäñÁ©çÂàÜ', ja: '500THB„ÇØ„É¨„Ç∏„ÉÉ„Éà' }, chance: '10%' },
  { prize: { en: 'Private Tour', zh: 'ÁßÅ‰∫∫Â∞éË¶Ω', ja: '„Éó„É©„Ç§„Éô„Éº„Éà„ÉÑ„Ç¢„Éº' }, chance: '5%' },
  { prize: { en: 'Mystery Box', zh: 'Á•ûÁßòÂØ∂ÁÆ±', ja: 'Ë¨é„ÅÆ„Éú„ÉÉ„ÇØ„Çπ' }, chance: '35%' },
];

export default function SiamInsider() {
  const [lang, setLang] = useState('en');
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState(null);
  const [admin, setAdmin] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeGacha, setActiveGacha] = useState(false);
  const [gachaResult, setGachaResult] = useState(null);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [venues, setVenues] = useState([]);
  const [venuePackages, setVenuePackages] = useState({});
  const [showAuth, setShowAuth] = useState(false);
  const [authMode, setAuthMode] = useState('login');
  const [authForm, setAuthForm] = useState({ email: '', password: '', confirmPassword: '', preferences: [] });
  const [authError, setAuthError] = useState('');
  const [showEmergency, setShowEmergency] = useState(false);
  const [emergencyForm, setEmergencyForm] = useState({ location: '', description: '' });
  const [emergencySuccess, setEmergencySuccess] = useState(false);
  const [showUpload, setShowUpload] = useState(false);
  const [uploadForm, setUploadForm] = useState({ venue: '', amount: '', paymentType: 'receipt' });
  const [uploadImage, setUploadImage] = useState(null);
  const [uploadImagePreview, setUploadImagePreview] = useState(null);
  const [uploading, setUploading] = useState(false);
  const [uploadSuccess, setUploadSuccess] = useState(false);
  const [mySubmissions, setMySubmissions] = useState([]);
  const [showAllVenues, setShowAllVenues] = useState(false);
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [showAdmin, setShowAdmin] = useState(false);
  const [adminTab, setAdminTab] = useState('dashboard');
  const [editingVenue, setEditingVenue] = useState(null);
  const [newVenue, setNewVenue] = useState({ name: '', drink_price: 0, rating: 0, risk_level: 'Low', location: '', category: 'A', description: '', decoration_level: 'ÊôÆÈÄö', friendliness: '‰∏≠', google_maps_url: '' });
  const [showPackageModal, setShowPackageModal] = useState(false);
  const [showAddVenue, setShowAddVenue] = useState(false);
  const [selectedVenueForPackage, setSelectedVenueForPackage] = useState(null);
  const [packageForm, setPackageForm] = useState({ name: '', duration_minutes: 60, price: 0, description: '' });
  const [adminReceipts, setAdminReceipts] = useState([]);
  const [adminStats, setAdminStats] = useState({ totalUsers: 0, totalVenues: 0, pendingReceipts: 0 });
  const fileInputRef = useRef(null);

  const t = translations[lang];

  useEffect(() => { checkUser(); fetchVenues(); }, []);
  useEffect(() => { if (user) fetchMySubmissions(); }, [user]);

  async function checkUser() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      setUser(session.user);
      await fetchProfile(session.user.id);
      await checkAdmin(session.user.id);
    }
    setLoading(false);
  }

  async function fetchProfile(userId) {
    const { data } = await supabase.from('profiles').select('*').eq('id', userId).single();
    if (data) setProfile(data);
  }

  async function checkAdmin(userId) {
    const { data } = await supabase.from('admins').select('*').eq('id', userId).single();
    if (data) setAdmin(data);
  }

  async function fetchVenues() {
    const { data } = await supabase.from('venues').select('*').order('drink_price', { ascending: true });
    if (data) {
      setVenues(data);
      fetchPackagesForVenues(data);
    }
  }

  async function fetchPackagesForVenues(venuesData) {
    const packages = {};
    for (const v of venuesData) {
      const { data } = await supabase.from('venue_packages').select('*').eq('venue_id', v.id);
      if (data) packages[v.id] = data;
    }
    setVenuePackages(packages);
  }

  async function fetchMySubmissions() {
    const { data } = await supabase.from('payment_receipts').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
    if (data) setMySubmissions(data);
  }

  async function fetchAdminData() {
    const [usersRes, receiptsRes] = await Promise.all([
      supabase.from('profiles').select('*'),
      supabase.from('payment_receipts').select('*').eq('status', 'pending')
    ]);
    if (usersRes.data) { setAdminUsers(usersRes.data); setAdminStats(s => ({ ...s, totalUsers: usersRes.data.length })); }
    if (receiptsRes.data) { setAdminReceipts(receiptsRes.data); setAdminStats(s => ({ ...s, pendingReceipts: receiptsRes.data.length })); }
    setAdminStats(s => ({ ...s, totalVenues: venues.length }));
  }

  async function handleAuth(e) {
    e.preventDefault();
    setAuthError('');
    if (authMode === 'signup' && authForm.password !== authForm.confirmPassword) { setAuthError('Passwords do not match'); return; }
    if (authMode === 'signup' && authForm.preferences.length === 0) { setAuthError('Please select at least one preference'); return; }
    try {
      if (authMode === 'signup') {
        const { data, error } = await supabase.auth.signUp({ email: authForm.email, password: authForm.password });
        if (error) throw error;
        if (data.user) await supabase.from('profiles').insert({ id: data.user.id, email: authForm.email, credits: 3, preferences: authForm.preferences });
        alert('Check your email for confirmation!');
      } else {
        const { data, error } = await supabase.auth.signInWithPassword({ email: authForm.email, password: authForm.password });
        if (error) throw error;
        setUser(data.user);
        await fetchProfile(data.user.id);
        await checkAdmin(data.user.id);
        setShowAuth(false);
      }
    } catch (err) { setAuthError(err.message); }
  }

  async function handleLogout() { await supabase.auth.signOut(); setUser(null); setProfile(null); setAdmin(null); setShowAdmin(false); }

  async function handleSpin() {
    if (!user) { setShowAuth(true); return; }
    if (!profile || profile.credits < 1) { alert('No credits left!'); return; }
    setActiveGacha(true);
    await supabase.from('profiles').update({ credits: profile.credits - 1 }).eq('id', user.id);
    setProfile({ ...profile, credits: profile.credits - 1 });
    setTimeout(() => {
      const rand = Math.random();
      let cumulative = 0, result = '';
      for (const reward of gachaRewards) { cumulative += parseFloat(reward.chance) / 100; if (rand < cumulative) { result = reward.prize[lang]; break; } }
      setGachaResult(result);
      setActiveGacha(false);
      supabase.from('gacha_results').insert({ user_id: user.id, reward: result });
    }, 2000);
  }

  function handleImageSelect(e) {
    const file = e.target.files[0];
    if (file) {
      setUploadImage(file);
      const reader = new FileReader();
      reader.onloadend = () => setUploadImagePreview(reader.result);
      reader.readAsDataURL(file);
    }
  }

  async function handleUpload(e) {
    e.preventDefault();
    if (!user) { setShowAuth(true); return; }
    if (!uploadForm.venue || !uploadForm.amount) { alert('Please fill in all fields'); return; }

    setUploading(true);
    let imageUrl = null;

    try {
      if (uploadImage) {
        const fileExt = uploadImage.name.split('.').pop();
        const fileName = `${user.id}/${Date.now()}.${fileExt}`;
        const { data: uploadData, error: uploadError } = await supabase.storage.from('payment-receipts').upload(fileName, uploadImage);
        if (uploadError) throw uploadError;
        imageUrl = uploadData.path;
      }

      const { error } = await supabase.from('payment_receipts').insert({
        user_id: user.id,
        venue_name: uploadForm.venue,
        amount: parseInt(uploadForm.amount),
        payment_type: uploadForm.paymentType,
        image_url: imageUrl,
        status: 'pending'
      });

      if (error) throw error;

      setUploadSuccess(true);
      fetchMySubmissions();
      setTimeout(() => {
        setShowUpload(false);
        setUploadSuccess(false);
        setUploadForm({ venue: '', amount: '', paymentType: 'receipt' });
        setUploadImage(null);
        setUploadImagePreview(null);
      }, 2000);
    } catch (err) {
      alert('Error: ' + err.message);
    } finally {
      setUploading(false);
    }
  }

  async function handleEmergency(e) {
    e.preventDefault();
    if (!user) { setShowAuth(true); return; }
    const { error } = await supabase.from('emergency_requests').insert({ user_id: user.id, location: emergencyForm.location, description: emergencyForm.description, status: 'pending' });
    if (error) { alert('Error: ' + error.message); return; }
    setEmergencySuccess(true);
    setTimeout(() => { setShowEmergency(false); setEmergencySuccess(false); setEmergencyForm({ location: '', description: '' }); }, 3000);
  }

  async function handleApproveReceipt(id) {
    await supabase.from('payment_receipts').update({ status: 'approved' }).eq('id', id);
    const receipt = adminReceipts.find(r => r.id === id);
    if (receipt) {
      const { data: profileData } = await supabase.from('profiles').select('credits').eq('id', receipt.user_id).single();
      if (profileData) {
        await supabase.from('profiles').update({ credits: profileData.credits + 1 }).eq('id', receipt.user_id);
      }
    }
    fetchAdminData();
  }

  async function handleRejectReceipt(id) {
    await supabase.from('payment_receipts').update({ status: 'rejected' }).eq('id', id);
    fetchAdminData();
  }

  async function handleSaveVenue() {
    if (editingVenue?.id) {
      await supabase.from('venues').update(editingVenue).eq('id', editingVenue.id);
    } else {
      await supabase.from('venues').insert(newVenue);
    }
    setEditingVenue(null);
    setNewVenue({ name: '', drink_price: 0, rating: 0, risk_level: 'Low', location: '', category: 'A', description: '', decoration_level: 'ÊôÆÈÄö', friendliness: '‰∏≠', google_maps_url: '' });
    fetchVenues();
  }

  async function handleDeleteVenue(id) {
    if (confirm('Delete this venue?')) {
      await supabase.from('venues').delete().eq('id', id);
      fetchVenues();
    }
  }

  async function handleAddPackage(e) {
    e.preventDefault();
    if (!selectedVenueForPackage) return;
    
    await supabase.from('venue_packages').insert({
      venue_id: selectedVenueForPackage,
      name: packageForm.name,
      duration_minutes: packageForm.duration_minutes,
      price: packageForm.price,
      description: packageForm.description
    });

    setShowPackageModal(false);
    setPackageForm({ name: '', duration_minutes: 60, price: 0, description: '' });
    setSelectedVenueForPackage(null);
    fetchVenues();
  }

  async function handleDeletePackage(id) {
    if (confirm('Delete this package?')) {
      await supabase.from('venue_packages').delete().eq('id', id);
      fetchVenues();
    }
  }

  useEffect(() => { if (showAdmin) fetchAdminData(); }, [showAdmin]);

  if (loading) return <div className="min-h-screen bg-[#0a0a0a] flex items-center justify-center"><Loader className="w-8 h-8 text-purple-500 animate-spin" /></div>;

  const filteredVenues = categoryFilter === 'all' ? venues : venues.filter(v => v.category === categoryFilter);

  if (showAdmin && admin) {
    return (
      <div className="min-h-screen bg-[#0a0a0a] text-white">
        <nav className="bg-[#1a1a1a] border-b border-purple-500/20 px-4 py-3 flex justify-between items-center">
          <div className="flex items-center space-x-2">
            <Shield className="w-6 h-6 text-purple-500" />
            <span className="font-bold"><span className="text-purple-500">SIAM</span><span className="text-amber-500">INSIDER</span> <span className="text-gray-500">Admin</span></span>
          </div>
          <div className="flex items-center space-x-4">
            <button onClick={() => setAdminTab('dashboard')} className={`px-3 py-1 rounded ${adminTab === 'dashboard' ? 'bg-purple-600' : 'text-gray-400'}`}>{t.admin.dashboard}</button>
            <button onClick={() => setAdminTab('venues')} className={`px-3 py-1 rounded ${adminTab === 'venues' ? 'bg-purple-600' : 'text-gray-400'}`}>{t.admin.venues}</button>
            <button onClick={() => setAdminTab('receipts')} className={`px-3 py-1 rounded ${adminTab === 'receipts' ? 'bg-purple-600' : 'text-gray-400'}`}>{t.admin.receipts}</button>
            <button onClick={() => { setShowAdmin(false); setAdminTab('dashboard'); }} className="px-3 py-1 border border-gray-600 rounded">Back</button>
          </div>
        </nav>
        <div className="p-4">
          {adminTab === 'dashboard' && (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-[#1a1a1a] p-6 rounded-xl border border-purple-500/20"><div className="text-3xl font-bold text-purple-500">{adminStats.totalUsers}</div><div className="text-gray-400">{t.admin.totalUsers}</div></div>
              <div className="bg-[#1a1a1a] p-6 rounded-xl border border-amber-500/20"><div className="text-3xl font-bold text-amber-500">{adminStats.totalVenues}</div><div className="text-gray-400">{t.admin.totalVenues}</div></div>
              <div className="bg-[#1a1a1a] p-6 rounded-xl border border-red-500/20"><div className="text-3xl font-bold text-red-500">{adminStats.pendingReceipts}</div><div className="text-gray-400">{t.admin.pendingReceipts}</div></div>
            </div>
          )}
          {adminTab === 'venues' && (
            <div>
              <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold">{t.admin.venues}</h2><button onClick={() => { setNewVenue({ name: "", drink_price: 0, rating: 0, risk_level: "Low", location: "", category: "A", description: "", decoration_level: "ÊôÆÈÄö", friendliness: "‰∏≠", google_maps_url: "" }); setShowAddVenue(true); }} className="px-4 py-2 bg-purple-600 rounded flex items-center space-x-2"><Plus className="w-4 h-4" /><span>{t.admin.addVenue}</span></button></div>
              <div className="grid gap-4">
                {venues.map(v => (
                  <div key={v.id} className="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800">
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <div className="font-bold text-lg">{v.name}</div>
                        <div className="text-sm text-gray-400 mt-1">
                          {v.drink_price}‡∏ø | {v.category} | {v.rating}‚òÖ | {v.decoration_level || 'ÊôÆÈÄö'} | {v.friendliness || '‰∏≠'}
                        </div>
                        {(venuePackages[v.id] || []).length > 0 && (
                          <div className="mt-2 flex flex-wrap gap-2">
                            {(venuePackages[v.id] || []).map(pkg => (
                              <span key={pkg.id} className="text-xs bg-purple-900/50 text-purple-300 px-2 py-1 rounded flex items-center gap-1">
                                <Package className="w-3 h-3" /> {pkg.name} ({pkg.duration_minutes}min/{pkg.price}‡∏ø)
                                <button onClick={() => handleDeletePackage(pkg.id)} className="ml-1 text-red-400 hover:text-red-300">√ó</button>
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                      <div className="flex space-x-2">
                        <button onClick={() => { setSelectedVenueForPackage(v.id); setShowPackageModal(true); }} className="p-2 text-green-400 hover:bg-green-400/10 rounded" title="Add Package"><Plus className="w-4 h-4" /></button>
                        <button onClick={() => { setEditingVenue(v); setShowAddVenue(false); }} className="p-2 text-blue-400 hover:bg-blue-400/10 rounded"><Edit className="w-4 h-4" /></button>
                        <button onClick={() => handleDeleteVenue(v.id)} className="p-2 text-red-400 hover:bg-red-400/10 rounded"><Trash2 className="w-4 h-4" /></button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              {(showAddVenue || editingVenue) && ( 
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                  <div className="bg-[#1a1a1a] p-6 rounded-xl w-full max-w-md max-h-[80vh] overflow-y-auto">
                    <h3 className="text-xl font-bold mb-4">{(editingVenue?.id) ? t.admin.editVenue : t.admin.addVenue}</h3>
                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm text-gray-400 mb-1">Â∫óÂÆ∂ÂêçÁ®±</label>
                        <input placeholder="Name" value={(showAddVenue ? newVenue.name : editingVenue?.name) || ''} onChange={e => showAddVenue ? setNewVenue({...newVenue, name: e.target.value}) : setEditingVenue({...editingVenue, name: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-400 mb-1">Âü∫Êú¨Ê∂àË≤ªÔºàTHB)/Â∞èÊôÇ</label>
                        <input placeholder="Price" type="number" value={(showAddVenue ? newVenue.drink_price : editingVenue?.drink_price) || 0} onChange={e => showAddVenue ? setNewVenue({...newVenue, drink_price: parseInt(e.target.value)}) : setEditingVenue({...editingVenue, drink_price: parseInt(e.target.value)})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-400 mb-1">Ë©ïÂàÜ</label>
                        <input placeholder="Rating" type="number" step="0.1" value={(showAddVenue ? newVenue.rating : editingVenue?.rating) || 0} onChange={e => showAddVenue ? setNewVenue({...newVenue, rating: parseFloat(e.target.value)}) : setEditingVenue({...editingVenue, rating: parseFloat(e.target.value)})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-400 mb-1">Â†¥ÊâÄÂàÜÈ°û (A-G)</label>
                        <select value={(showAddVenue ? newVenue.category : editingVenue?.category) || 'A'} onChange={e => showAddVenue ? setNewVenue({...newVenue, category: e.target.value}) : setEditingVenue({...editingVenue, category: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700">
                          {Object.keys(PREFERENCE_LABELS).map(c => <option key={c} value={c}>{c} - {PREFERENCE_LABELS[c][lang]}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm text-gray-400 mb-1">Ë£ùÊΩ¢Á®ãÂ∫¶</label>
                        <select value={(showAddVenue ? newVenue.decoration_level : editingVenue?.decoration_level) || 'ÊôÆÈÄö'} onChange={e => showAddVenue ? setNewVenue({...newVenue, decoration_level: e.target.value}) : setEditingVenue({...editingVenue, decoration_level: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700">
                          {DECORATION_LEVELS.map(d => <option key={d.value} value={d.value}>{d.value}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm text-gray-400 mb-1">Â∫óÂÆ∂Ë¶™ÂíåÂäõ</label>
                        <select value={(showAddVenue ? newVenue.friendliness : editingVenue?.friendliness) || '‰∏≠'} onChange={e => showAddVenue ? setNewVenue({...newVenue, friendliness: e.target.value}) : setEditingVenue({...editingVenue, friendliness: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700">
                          {FRIENDLINESS_LEVELS.map(f => <option key={f.value} value={f.value}>{f.value}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm text-gray-400 mb-1">Âú∞Èªû</label>
                        <input placeholder="Location" value={(showAddVenue ? newVenue.location : editingVenue?.location) || ''} onChange={e => showAddVenue ? setNewVenue({...newVenue, location: e.target.value}) : setEditingVenue({...editingVenue, location: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-400 mb-1">Google Maps ‰ΩçÁΩÆ</label>
                        <input placeholder="https://maps.google.com/..." value={(showAddVenue ? newVenue.google_maps_url : editingVenue?.google_maps_url) || ''} onChange={e => showAddVenue ? setNewVenue({...newVenue, google_maps_url: e.target.value}) : setEditingVenue({...editingVenue, google_maps_url: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700" />
                      </div>
                      <div className="flex space-x-2">
                        <button onClick={handleSaveVenue} className="flex-1 py-3 bg-purple-600 rounded font-bold">{t.admin.save}</button>
                        <button onClick={() => { setEditingVenue(null); setShowAddVenue(false); }} className="flex-1 py-3 border border-gray-600 rounded">{t.admin.cancel}</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
          {adminTab === 'receipts' && (
            <div>
              <h2 className="text-xl font-bold mb-4">{t.admin.receipts}</h2>
              <div className="space-y-3">
                {adminReceipts.map(r => (
                  <div key={r.id} className="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800">
                    <div className="flex justify-between items-start">
                      <div>
                        <div className="font-bold">{r.venue_name}</div>
                        <div className="text-sm text-gray-400">{r.amount} THB | {r.payment_type}</div>
                        {r.image_url && <div className="text-xs text-purple-400 mt-1">üìé Image attached</div>}
                      </div>
                      <div className="flex space-x-2">
                        <button onClick={() => handleApproveReceipt(r.id)} className="px-3 py-1 bg-green-600 rounded text-sm">{t.admin.approve}</button>
                        <button onClick={() => handleRejectReceipt(r.id)} className="px-3 py-1 bg-red-600 rounded text-sm">{t.admin.reject}</button>
                      </div>
                    </div>
                  </div>
                ))}
                {adminReceipts.length === 0 && <p className="text-gray-400">No pending receipts</p>}
              </div>
            </div>
          )}
        </div>

        {/* Package Modal */}
        {showPackageModal && (
          <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
            <div className="bg-[#1a1a1a] p-6 rounded-xl w-full max-w-md">
              <h3 className="text-xl font-bold mb-4">{t.admin.addPackage}</h3>
              <form onSubmit={handleAddPackage} className="space-y-3">
                <input placeholder={t.admin.packageName} value={packageForm.name} onChange={e => setPackageForm({...packageForm, name: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700" required />
                <input placeholder={t.admin.duration} type="number" value={packageForm.duration_minutes} onChange={e => setPackageForm({...packageForm, duration_minutes: parseInt(e.target.value)})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700" required />
                <input placeholder={t.admin.price} type="number" value={packageForm.price} onChange={e => setPackageForm({...packageForm, price: parseInt(e.target.value)})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700" required />
                <textarea placeholder={t.admin.description} value={packageForm.description} onChange={e => setPackageForm({...packageForm, description: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded border border-gray-700 h-20" />
                <div className="flex space-x-2">
                  <button type="submit" className="flex-1 py-3 bg-green-600 rounded font-bold">{t.admin.save}</button>
                  <button type="button" onClick={() => { setShowPackageModal(false); setPackageForm({ name: '', duration_minutes: 60, price: 0, description: '' }); }} className="flex-1 py-3 border border-gray-600 rounded">{t.admin.cancel}</button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-sans">
      <nav className="fixed top-0 left-0 right-0 z-50 bg-[#0a0a0a]/95 backdrop-blur-md border-b border-purple-500/20">
        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
          <div className="flex items-center space-x-2"><Shield className="w-7 h-7 text-purple-500" /><span className="text-lg font-bold tracking-wider"><span className="text-purple-500">SIAM</span><span className="text-amber-500">INSIDER</span></span></div>
          <div className="flex items-center space-x-1 bg-[#1a1a1a] rounded-lg p-1">{['en', 'zh', 'ja'].map(l => <button key={l} onClick={() => setLang(l)} className={`px-2 py-1 text-xs rounded ${lang === l ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'}`}>{l.toUpperCase()}</button>)}</div>
          <div className="hidden md:flex items-center space-x-4 text-sm">
            {user && <div className="flex items-center space-x-2 text-amber-500"><Ticket className="w-4 h-4" /><span>{profile?.credits || 0} {t.nav.credits}</span></div>}
            <a href="#dashboard" className="hover:text-purple-400 transition">{t.nav.dashboard}</a>
            <a href="#membership" className="hover:text-purple-400 transition">{t.nav.membership}</a>
            <a href="#gacha" className="hover:text-purple-400 transition">{t.nav.gacha}</a>
            {admin && <button onClick={() => setShowAdmin(true)} className="text-red-400 hover:text-red-300">{t.nav.admin}</button>}
            {user ? <button onClick={handleLogout} className="flex items-center space-x-1 px-3 py-2 border border-red-500/50 text-red-500 rounded hover:bg-red-500/10 transition"><LogOut className="w-4 h-4" /><span>{t.nav.logout}</span></button> : <button onClick={() => setShowAuth(true)} className="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-medium transition">{t.nav.login}</button>}
          </div>
          <button className="md:hidden p-2" onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>{mobileMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}</button>
        </div>
        {mobileMenuOpen && <div className="md:hidden bg-[#0a0a0a] border-t border-purple-500/20 px-4 py-4 space-y-3">{user && <div className="flex items-center justify-between py-2 text-amber-500"><span>{t.nav.credits}: {profile?.credits || 0}</span></div>}<a href="#dashboard" className="block py-2" onClick={() => setMobileMenuOpen(false)}>{t.nav.dashboard}</a><a href="#membership" className="block py-2" onClick={() => setMobileMenuOpen(false)}>{t.nav.membership}</a><a href="#gacha" className="block py-2" onClick={() => setMobileMenuOpen(false)}>{t.nav.gacha}</a>{admin && <button onClick={() => { setShowAdmin(true); setMobileMenuOpen(false); }} className="block py-2 text-red-400">{t.nav.admin}</button>}{user ? <button onClick={handleLogout} className="w-full py-3 border border-red-500/50 text-red-500 rounded">{t.nav.logout}</button> : <button onClick={() => { setShowAuth(true); setMobileMenuOpen(false); }} className="w-full py-3 bg-purple-600 rounded">{t.nav.login}</button>}</div>}
      </nav>
      {showAuth && <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"><div className="bg-[#1a1a1a] rounded-2xl p-6 w-full max-w-md border border-purple-500/30"><h2 className="text-2xl font-bold mb-6">{authMode === 'login' ? t.auth.login : t.auth.signup}</h2><form onSubmit={handleAuth} className="space-y-4"><div><label className="block text-sm text-gray-400 mb-1">{t.auth.email}</label><input type="email" value={authForm.email} onChange={e => setAuthForm({...authForm, email: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded-lg border border-gray-700 focus:border-purple-500 outline-none" required /></div><div><label className="block text-sm text-gray-400 mb-1">{t.auth.password}</label><input type="password" value={authForm.password} onChange={e => setAuthForm({...authForm, password: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded-lg border border-gray-700 focus:border-purple-500 outline-none" required /></div>{authMode === 'signup' && (<><div><label className="block text-sm text-gray-400 mb-1">{t.auth.confirmPassword}</label><input type="password" value={authForm.confirmPassword} onChange={e => setAuthForm({...authForm, confirmPassword: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded-lg border border-gray-700 focus:border-purple-500 outline-none" required /></div><div><label className="block text-sm text-gray-400 mb-2">{t.auth.selectPreferences}</label><div className="flex flex-wrap gap-2">{Object.keys(PREFERENCE_LABELS).map(p => <button key={p} type="button" onClick={() => setAuthForm({...authForm, preferences: authForm.preferences.includes(p) ? authForm.preferences.filter(x => x !== p) : [...authForm.preferences, p]})} className={`px-3 py-1 rounded border ${authForm.preferences.includes(p) ? 'bg-purple-600 border-purple-500' : 'border-gray-700'}`}>{p} - {PREFERENCE_LABELS[p][lang]}</button>)}</div></div></>)}{authError && <p className="text-red-500 text-sm">{authError}</p>}<button type="submit" className="w-full py-3 bg-purple-600 rounded-lg font-bold hover:bg-purple-700 transition">{authMode === 'login' ? t.auth.login : t.auth.signup}</button></form><p className="text-center text-gray-400 text-sm mt-4">{authMode === 'login' ? t.auth.noAccount : t.auth.hasAccount}<button onClick={() => setAuthMode(authMode === 'login' ? 'signup' : 'login')} className="text-purple-400 ml-1">{authMode === 'login' ? t.auth.signup : t.auth.login}</button></p><button onClick={() => setShowAuth(false)} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X className="w-6 h-6" /></button></div></div>}
      <section className="relative pt-28 pb-16 px-4 overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-b from-purple-900/20 to-transparent" />
        <div className="absolute top-20 left-10 w-72 h-72 bg-purple-500/10 rounded-full blur-3xl" />
        <div className="absolute bottom-10 right-10 w-96 h-96 bg-amber-500/10 rounded-full blur-3xl" />
        <div className="max-w-4xl mx-auto relative z-10 text-center">
          <div className="inline-flex items-center space-x-2 bg-purple-900/30 border border-purple-500/30 rounded-full px-3 py-1.5 mb-6"><Lock className="w-3 h-3 text-purple-400" /><span className="text-sm text-purple-300">{t.hero.trustActive}</span></div>
          <h1 className="text-3xl md:text-5xl lg:text-6xl font-bold mb-4 leading-tight">{t.hero.title}</h1>
          <p className="text-base md:text-xl text-gray-400 mb-8 max-w-2xl mx-auto">{t.hero.subtitle}</p>
          <div className="flex flex-col sm:flex-row justify-center gap-3 mb-10"><button onClick={() => user ? document.getElementById('membership').scrollIntoView() : setShowAuth(true)} className="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-800 rounded-lg font-bold hover:scale-105 transition flex items-center justify-center space-x-2"><span>{t.hero.cta}</span><ChevronRight className="w-4 h-4" /></button><button className="px-6 py-3 border border-amber-500/50 text-amber-500 rounded-lg font-bold hover:bg-amber-500/10 transition flex items-center justify-center space-x-2"><AlertTriangle className="w-4 h-4" /><span>{t.hero.cta2}</span></button></div>
          <div className="grid grid-cols-3 gap-4 pt-10 border-t border-gray-800"><div><div className="text-2xl md:text-4xl font-bold text-purple-500">2,000+</div><div className="text-xs md:text-sm text-gray-500 mt-1">{t.hero.verified}</div></div><div><div className="text-2xl md:text-4xl font-bold text-amber-500">500+</div><div className="text-xs md:text-sm text-gray-500 mt-1">{t.hero.reports}</div></div><div><div className="text-2xl md:text-4xl font-bold text-green-500">99.7%</div><div className="text-xs md:text-sm text-gray-500 mt-1">{t.hero.satisfaction}</div></div></div>
        </div>
      </section>
      <section id="dashboard" className="py-12 px-4 bg-[#0f0f0f]">
        <div className="max-w-7xl mx-auto">
          <div className="flex items-center space-x-3 mb-8"><Activity className="w-7 h-7 text-purple-500" /><h2 className="text-2xl font-bold">{t.dashboard.title}</h2>{user && profile && <span className="ml-auto text-amber-500 flex items-center space-x-1"><Ticket className="w-4 h-4" /><span>{t.dashboard.yourCredits}: {profile.credits}</span></span>}</div>
          <div className="grid lg:grid-cols-2 gap-6">
            <div className="bg-[#1a1a1a] rounded-2xl p-5 border border-purple-500/20">
              <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold flex items-center space-x-2"><DollarSign className="w-5 h-5 text-amber-500" /><span>{t.dashboard.priceIndex}</span></h3><span className="text-xs text-gray-500">{t.dashboard.updated}</span></div>
              <div className="space-y-3">{filteredVenues.slice(0, showAllVenues ? 20 : 5).map((item, i) => (<div key={i} className="flex items-center justify-between p-3 bg-[#0a0a0a] rounded-lg"><div className="flex items-center space-x-3"><div className="w-9 h-9 bg-purple-900/50 rounded-lg flex items-center justify-center"><Star className="w-4 h-4 text-purple-400" /></div><div><div className="font-medium text-sm">{item.name}</div><div className="text-xs text-gray-500 flex items-center space-x-1"><span className={`px-1.5 py-0.5 rounded text-xs ${item.risk_level === 'Low' ? 'bg-green-900 text-green-400' : 'bg-amber-900 text-amber-400'}`}>{item.risk_level}</span><span className="text-gray-600">|</span><span className="text-purple-400">{item.category}</span><span className="text-gray-600">|</span><span className="text-amber-400">{item.decoration_level || 'ÊôÆÈÄö'}</span></div></div></div><div className="text-right"><div className="text-amber-500 font-bold">{item.drink_price}‡∏ø</div><div className="text-xs text-gray-500">{item.rating} ‚òÖ</div></div></div>))}</div>
              <div className="flex gap-2 mt-4"><button onClick={() => setShowAllVenues(!showAllVenues)} className="flex-1 py-3 border border-purple-500/30 text-purple-400 rounded-lg hover:bg-purple-500/10 transition text-sm">{showAllVenues ? 'Show Less' : t.dashboard.viewAll}</button><select value={categoryFilter} onChange={e => setCategoryFilter(e.target.value)} className="py-3 px-2 bg-[#0a0a0a] border border-purple-500/30 rounded-lg text-sm">{Object.keys(PREFERENCE_LABELS).map(c => <option key={c} value={c}>{c} - {PREFERENCE_LABELS[c][lang]}</option>)}</select></div>
            </div>
            <div className="space-4">
              <div className="bg-[#1a1a1a] rounded-2xl p-5 border border-amber-500/20"><h3 className="text-lg font-bold mb-3 flex items-center space-x-2"><Shield className="w-5 h-5 text-amber-500" /><span>{t.dashboard.trustProtocol}</span></h3><div className="space-y-2"><div className="flex items-center justify-between p-2.5 bg-[#0a0a0a] rounded-lg"><span className="text-gray-400 text-sm">{t.dashboard.venueVerify}</span><span className="text-green-400 flex items-center space-x-1 text-sm"><span className="w-2 h-2 bg-green-400 rounded-full animate-pulse" /><span>Active</span></span></div><div className="flex items-center justify-between p-2.5 bg-[#0a0a0a] rounded-lg"><span className="text-gray-400 text-sm">{t.dashboard.priceSync}</span><span className="text-green-400 flex items-center space-x-1 text-sm"><span className="w-2 h-2 bg-green-400 rounded-full animate-pulse" /><span>Live</span></span></div></div></div>
              <div className="bg-gradient-to-br from-red-900/20 to-[#1a1a1a] rounded-2xl p-5 border border-red-500/30"><h3 className="text-lg font-bold mb-2 flex items-center space-x-2"><Heart className="w-5 h-5 text-red-500" /><span>{t.dashboard.emergency}</span></h3><p className="text-gray-400 text-sm mb-3">{t.dashboard.emergencyDesc}</p><button onClick={() => setShowEmergency(true)} className="w-full py-3 bg-red-600 hover:bg-red-700 rounded-lg font-bold transition flex items-center justify-center space-x-2 text-sm"><Clock className="w-4 h-4" /><span>{t.dashboard.activate}</span></button></div>
            </div>
          </div>
        </div>
      </section>
      {showEmergency && <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"><div className="bg-[#1a1a1a] rounded-2xl p-6 w-full max-w-md border border-red-500/30">{emergencySuccess ? <div className="text-center py-8"><CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" /><p className="text-lg">{t.emergency.success}</p></div> : <><h2 className="text-2xl font-bold mb-6 flex items-center space-x-2"><Heart className="w-6 h-6 text-red-500" /><span>{t.emergency.title}</span></h2><form onSubmit={handleEmergency} className="space-y-4"><div><label className="block text-sm text-gray-400 mb-1">Location</label><input type="text" value={emergencyForm.location} onChange={e => setEmergencyForm({...emergencyForm, location: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded-lg border border-gray-700 focus:border-red-500 outline-none" required /></div><div><label className="block text-sm text-gray-400 mb-1">Description</label><textarea value={emergencyForm.description} onChange={e => setEmergencyForm({...emergencyForm, description: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded-lg border border-gray-700 focus:border-red-500 outline-none h-24" required /></div><button type="submit" className="w-full py-3 bg-red-600 rounded-lg font-bold hover:bg-red-700 transition">Submit</button></form></>}<button onClick={() => setShowEmergency(false)} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X className="w-6 h-6" /></button></div></div>}
      <section id="gacha" className="py-12 px-4">
        <div className="max-w-7xl mx-auto">
          <div className="text-center mb-10"><div className="flex items-center justify-center space-x-3 mb-3"><Ticket className="w-7 h-7 text-amber-500" /><h2 className="text-2xl font-bold">{t.gacha.title}</h2></div><p className="text-gray-400 text-sm">{t.gacha.subtitle}</p></div>
          <div className="max-w-sm mx-auto">
            <div className="bg-[#1a1a1a] rounded-2xl p-6 border border-amber-500/30 text-center">
              <div className="relative w-36 h-36 mx-auto mb-6"><div className={`absolute inset-0 bg-gradient-to-br from-purple-600 to-amber-600 rounded-full ${activeGacha ? 'animate-spin' : 'animate-pulse'}`} style={{animationDuration: '3s'}} /><div className="absolute inset-3 bg-[#0a0a0a] rounded-full flex items-center justify-center">{gachaResult ? <span className="text-lg font-bold text-amber-400 px-2">{gachaResult}</span> : <span className="text-4xl">üé∞</span>}</div></div>
              <button onClick={handleSpin} disabled={activeGacha} className="w-full py-3.5 bg-gradient-to-r from-amber-500 to-amber-700 rounded-lg font-bold hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed">{activeGacha ? t.gacha.spinning : `${t.gacha.spin} (1 ${t.nav.credits})`}</button>
              <button onClick={() => setShowUpload(true)} className="w-full mt-3 py-3 border border-purple-500/30 text-purple-400 rounded-lg hover:bg-purple-500/10 transition flex items-center justify-center space-x-2"><Upload className="w-4 h-4" /><span>{t.gacha.uploadProof}</span></button>
              <div className="mt-6 text-left"><h4 className="text-sm font-bold text-gray-500 mb-2">{t.gacha.rewardPool}</h4><div className="space-y-1.5">{gachaRewards.map((reward, i) => (<div key={i} className="flex justify-between text-sm"><span className="text-gray-400">{reward.prize[lang]}</span><span className="text-amber-500">{reward.chance}</span></div>))}</div></div>
            </div>
            {user && <div className="mt-6 max-w-sm mx-auto"><h3 className="text-lg font-bold mb-3">{t.gacha.mySubmissions}</h3><div className="space-y-2">{mySubmissions.length > 0 ? mySubmissions.map(s => (<div key={s.id} className="bg-[#1a1a1a] p-3 rounded-lg flex justify-between items-center"><div><div className="font-medium text-sm">{s.venue_name}</div><div className="text-xs text-gray-400">{s.amount} THB | {s.payment_type}</div></div><span className={`text-xs px-2 py-1 rounded ${s.status === 'pending' ? 'bg-yellow-900 text-yellow-400' : s.status === 'approved' ? 'bg-green-900 text-green-400' : 'bg-red-900 text-red-400'}`}>{s.status === 'pending' ? t.gacha.pendingApproval : s.status === 'approved' ? t.gacha.approved : t.gacha.rejected}</span></div>)) : <p className="text-gray-400 text-sm">{t.gacha.noSubmissions}</p>}</div></div>}
          </div>
        </div>
      </section>
      {showUpload && <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"><div className="bg-[#1a1a1a] rounded-2xl p-6 w-full max-w-md border border-purple-500/30">{uploadSuccess ? <div className="text-center py-8"><CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" /><p className="text-lg text-green-500">{t.gacha.uploadSuccess}</p></div> : <><h2 className="text-2xl font-bold mb-6">{t.gacha.uploadProof}</h2><form onSubmit={handleUpload} className="space-y-4"><div><label className="block text-sm text-gray-400 mb-1">{t.gacha.selectVenue}</label><select value={uploadForm.venue} onChange={e => setUploadForm({...uploadForm, venue: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded-lg border border-gray-700 focus:border-purple-500 outline-none" required><option value="">-- {t.gacha.selectVenue} --</option>{venues.map(v => <option key={v.id} value={v.name}>{v.name}</option>)}</select></div><div><label className="block text-sm text-gray-400 mb-1">{t.gacha.enterAmount}</label><input type="number" value={uploadForm.amount} onChange={e => setUploadForm({...uploadForm, amount: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded-lg border border-gray-700 focus:border-purple-500 outline-none" required /></div><div><label className="block text-sm text-gray-400 mb-1">{t.gacha.paymentType}</label><select value={uploadForm.paymentType} onChange={e => setUploadForm({...uploadForm, paymentType: e.target.value})} className="w-full p-3 bg-[#0a0a0a] rounded-lg border border-gray-700 focus:border-purple-500 outline-none"><option value="receipt">{t.gacha.receipt}</option><option value="transfer">{t.gacha.transfer}</option><option value="card">{t.gacha.card}</option></select></div><div><label className="block text-sm text-gray-400 mb-1">{t.gacha.uploadImage}</label><div className="border-2 border-dashed border-gray-700 rounded-lg p-4 text-center cursor-pointer hover:border-purple-500 transition" onClick={() => fileInputRef.current?.click()}>{uploadImagePreview ? <><img src={uploadImagePreview} alt="Preview" className="max-h-32 mx-auto rounded" /><p className="text-xs text-green-400 mt-2">{t.gacha.selected}</p></> : <><ImageIcon className="w-8 h-8 text-gray-500 mx-auto mb-2" /><p className="text-sm text-gray-400">{t.gacha.uploadImage}</p></>}</div><input ref={fileInputRef} type="file" accept="image/*" onChange={handleImageSelect} className="hidden" /></div><button type="submit" disabled={uploading} className="w-full py-3 bg-purple-600 rounded-lg font-bold hover:bg-purple-700 transition disabled:opacity-50">{uploading ? 'Uploading...' : t.gacha.uploadProof}</button></form></>}<button onClick={() => { setShowUpload(false); setUploadImage(null); setUploadImagePreview(null); }} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X className="w-6 h-6" /></button></div></div>}
      <section id="membership" className="py-12 px-4 bg-[#0f0f0f]">
        <div className="max-w-7xl mx-auto">
          <div className="text-center mb-12"><h2 className="text-2xl md:text-3xl font-bold mb-2">{t.membership.title}</h2><p className="text-gray-400 text-sm">{t.membership.subtitle}</p></div>
          <div className="grid md:grid-cols-3 gap-6">{tiers.map((tier, i) => (<div key={i} className={`relative bg-[#1a1a1a] rounded-2xl p-6 border-2 transition hover:scale-[1.02] ${tier.popular ? 'border-purple-500' : 'border-gray-800 hover:border-purple-500/50'}`}>{tier.popular && <div className="absolute -top-3 left-1/2 -translate-x-1/2 px-3 py-0.5 bg-purple-600 rounded-full text-xs font-bold">{t.membership.popular}</div>}<div className={`w-14 h-14 rounded-xl bg-gradient-to-br ${tier.color} flex items-center justify-center mb-4`}><tier.icon className="w-7 h-7 text-white" /></div><h3 className="text-xl font-bold mb-1">{tier.name[lang]}</h3><div className="mb-4"><span className="text-3xl font-bold text-white">{tier.price}</span><span className="text-gray-500 text-sm">{tier.period[lang]}</span></div><button className={`w-full py-3.5 rounded-lg font-bold transition ${tier.popular ? 'bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-500 hover:to-purple-700' : 'border border-purple-500 text-purple-400 hover:bg-purple-500/10'}`}>{t.membership.getStarted}</button></div>))}</div>
        </div>
      </section>
      <footer className="py-8 px-4 border-t border-gray-800">
        <div className="max-w-7xl mx-auto"><div className="flex flex-col md:flex-row justify-between items-center"><div className="flex items-center space-x-2 mb-4 md:mb-0"><Shield className="w-5 h-5 text-purple-500" /><span className="font-bold text-sm"><span className="text-purple-500">SIAM</span><span className="text-amber-500">INSIDER</span></span></div><div className="flex space-x-4 text-xs text-gray-500"><a href="#" className="hover:text-white transition">{t.footer.privacy}</a><a href="#" className="hover:text-white transition">{t.footer.terms}</a><a href="#" className="hover:text-white transition">{t.footer.contact}</a></div></div><div className="text-center text-gray-600 text-xs mt-6">¬© 2026 Siam Insider. {t.footer.rights}</div></div>
      </footer>
    </div>
  );
}
